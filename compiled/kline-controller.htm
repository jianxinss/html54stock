<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=GBK"/>
    <title>K线控制器</title>
    <script>
(function(){function b(){this.tapTimeLimit=500}Array.prototype.each=function(d,f,c){f=f||0;c=c||this.length-1;for(var e=f;e<=c;e++){d(this[e],this,e);if(this.breakLoop){this.breakLoop=false;break}}};b.prototype={preventDefaultEvent:function(c){if(c.preventDefault){c.preventDefault()}else{c.returnValue=false}},isTouchDevice:function(){return !!("ontouchstart" in window)},toMoney:function(c){return c.toFixed(2)},bigNumberToText:function(d){var c;var f=d/100000000;if(f>1){c=f.toFixed(2)+"亿"}else{var e=d/10000;if(e>1){c=e.toFixed()+"万"}else{c=d}}return c},getOffset:function(c){if(!isNaN(c.offsetX)&&!isNaN(c.offsetY)){return c}var h=c.target;if(h.offsetLeft==undefined){h=h.parentNode}var g=getPageCoord(h);var d={x:window.pageXOffset+c.clientX,y:window.pageYOffset+c.clientY};var f={offsetX:d.x-g.x,offsetY:d.y-g.y};return f},getPageCoord:function(d){var c={x:0,y:0};while(d){c.x+=d.offsetLeft;c.y+=d.offsetTop;d=d.offsetParent}return c},addLoadEvent:function(c){var d=window.onload;if(typeof d!="function"){window.onload=c}else{window.onload=function(){d();c()}}},addEvent:function(c,d,e,g){if(c.addEventListener){c.addEventListener(d,e,g);return true}else{if(c.attachEvent){var f=c.attachEvent("on"+d,e);return f}else{c["on"+d]=e}}},getEventTarget:function(c){return c.srcElement||c.target||c.relatedTarget},$id:function(c){return document.getElementById(c)}};window.extendObject=function(e,c){for(var d in e){c[d]=e[d]}};window.extendWindow=function(c){extendObject(c,window)};var a=new b();extendWindow(a);window.getQueryParam=function(f,c){var e=new RegExp("[?&]"+f+"=([^&]+)","i");var d=e.exec(c?window.top.location.search:location.search);if(d&&d.length>1){return decodeURIComponent(d[1])}else{return""}};window.debug=getQueryParam("debug");window.setDebugMsg=function(d){if(window.debug){try{var f="debug";var e=$id(f);if(!e){e=document.createElement("DIV");e.id=f;document.body.appendChild(e)}e.innerHTML=(window.debug==2?(d+"<br/>"+e.innerHTML):d)}catch(c){alert(d+";error:"+c)}}}})();function controller(a,b){this.canvas=$id(a);this.ctx=this.canvas.getContext("2d");this.region=b.region;this.bar=b.bar;this.value=b.value;this.minBarDistance=b.minBarDistance||5;this.onPositionChanged=b.onPositionChanged;this.prePaint=b.prePaint;this.isTouchDevice=isTouchDevice();this.touchFaultTolerance=b.touchFaultTolerance}controller.prototype={calcPositions:function(){var a=(this.region.width-this.bar.width);this.leftBarPosition=this.value.left*a/100+this.bar.width/2;this.rightBarPosition=this.value.right*a/100+this.bar.width/2},drawControllerPart:function(){var b=this.canvas;var c=this.ctx;c.save();var f=this.region;var a=this.bar;this.calcPositions();var d=this.leftBarPosition;var g=this.rightBarPosition;c.clearRect(f.x-1,f.y-1,f.width+1,f.height+1);if(typeof this.prePaint=="function"){this.prePaint(c)}c.lineWidth=1;c.strokeStyle=f.borderColor;c.beginPath();c.moveTo(f.x,f.y);c.lineTo(f.x,f.y+f.height);c.lineTo(f.x+d,f.y+f.height);c.lineTo(f.x+d,f.y+f.height-(f.height-a.height)/2);c.stroke();c.strokeStyle=f.borderColor;c.beginPath();c.moveTo(f.x+d,f.y+f.height/2-a.height/2);c.lineTo(f.x+d,f.y);c.lineTo(f.x,f.y);c.stroke();c.beginPath();c.moveTo(f.x+d,f.y+f.height);c.lineTo(f.x+f.width,f.y+f.height);c.lineTo(f.x+f.width,f.y);c.lineTo(f.x+g,f.y);c.lineTo(f.x+g,f.y+f.height/2-a.height/2);c.stroke();c.beginPath();c.moveTo(f.x+g,f.y+f.height/2+a.height/2);c.lineTo(f.x+g,f.y+f.height);c.stroke();c.beginPath();c.fillStyle="blue";c.globalAlpha=0.5;c.rect(f.x+d,f.y,g-d,f.height);c.closePath();c.fill();c.globalAlpha=1;c.strokeStyle=a.borderColor;c.fillStyle=a.fillColor;c.beginPath();var e={x:f.x+d-a.width/2,y:f.y+f.height/2-a.height/2,width:a.width,height:a.height};c.rect(e.x,e.y,e.width,e.height);this.leftBarRegion=e;c.closePath();c.stroke();c.fill();c.beginPath();var h={x:f.x+g-a.width/2,y:f.y+f.height/2-a.height/2,width:a.width,height:a.height};c.rect(h.x,h.y,h.width,h.height);this.rightBarRegion=h;c.closePath();c.stroke();c.fill();c.restore()},setLeftBarPosition:function(a){if(a<this.bar.width/2){this.leftBarPosition=this.bar.width/2}else{if(this.rightBarPosition-a-this.minBarDistance>this.bar.width){this.leftBarPosition=a}else{this.leftBarPosition=this.rightBarPosition-this.bar.width-this.minBarDistance}}this.value=this.getValue()},setRightBarPosition:function(a){if(a<this.leftBarPosition+this.bar.width+this.minBarDistance){this.rightBarPosition=this.leftBarPosition+this.bar.width+this.minBarDistance}else{if(a>this.region.width-this.bar.width/2){this.rightBarPosition=this.region.width-this.bar.width/2}else{this.rightBarPosition=a}}this.value=this.getValue()},addControllerEvents:function(){var c=this;if(c.isTouchDevice){var a=c.canvas;addEvent(a,"touchmove",function(k){k=k||event;var p=k.srcElement||k.target||k.relatedTarget;var r=k.touches;if(!r||!r.length){return}var g=false;var f=getPageCoord(this.canvas);if(c.fingers&&c.fingers.length){for(var m=0;m<c.fingers.length;m++){var l=c.fingers[m];for(var n=0;n<r.length;n++){var q=r[n];if(q.identifier==l.id){var h=q.pageX-f.x;var o=(h-l.startX);if(o!=0){if(l.type=="left"){c.setLeftBarPosition(l.leftPosition+o)}else{if(l.type=="right"){c.setRightBarPosition(l.rightPosition+o)}else{c.setLeftBarPosition(l.leftPosition+o);c.setRightBarPosition(l.rightPosition+o)}}g=true}break}}}}if(g){c.drawControllerPart();if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}}disableBubbleAndPreventDefault(k)});addEvent(a,"touchend",function(h){h=h||event;if(c.fingers&&c.fingers.length){if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}}else{var l=new Date().getTime()-c.touchstartTime.getTime();if(l<window.tapTimeLimit&&c.startTouch){var f=getPageCoord(c.canvas);var i=c.startTouch;var k={offsetX:i.pageX-f.x,offsetY:i.pageY-f.y};var g=(c.rightBarPosition+c.leftBarPosition)/2;var j=k.offsetX-g;c.setLeftBarPosition(c.leftBarPosition+j);c.setRightBarPosition(c.rightBarPosition+j);c.drawControllerPart();if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}c.startTouch=null}}c.fingers=null;disableBubbleAndPreventDefault(h)});addEvent(a,"touchstart",function(g){var o=g.touches;if(!o||!o.length){o=g.changedTouches}c.touchstartTime=new Date();c.startTouch=o[0];var m=g.srcElement||g.target||g.relatedTarget;var f=getPageCoord(c.canvas);function j(i){if(c.isOnLeftBar(i)){return"left"}if(c.isOnRightBar(i)){return"right"}if(c._isBetweenLeftAndRight(i)){return"middle"}return false}c.fingers=[];if(o.length){for(var k=0;k<o.length;k++){var n=o[k];var l={offsetX:n.pageX-f.x,offsetY:n.pageY-f.y};var p=j(l);if(!p){continue}var h={id:n.identifier,startX:n.pageX-f.x,type:p,leftPosition:c.leftBarPosition,rightPosition:c.rightBarPosition};c.fingers.push(h)}}disableBubbleAndPreventDefault(g);return false})}else{var d=function(f){var g=c.isOnLeftBar(f);var h=c.isOnRightBar(f);if(c._isBetweenLeftAndRight(f)){document.body.style.cursor="pointer"}else{if(g||h||c.triggerBar){document.body.style.cursor="col-resize"}else{document.body.style.cursor="default"}}if(c.triggerBar){c.triggerBar.targetX=f.offsetX;var i=(c.triggerBar.targetX-c.triggerBar.x);if(c.triggerBar.type=="left"){document.body.style.cursor="col-resize";c.setLeftBarPosition(c.triggerBar.position+i)}else{if(c.triggerBar.type=="right"){c.setRightBarPosition(c.triggerBar.position+i)}else{c.setLeftBarPosition(c.triggerBar.leftPosition+i);c.setRightBarPosition(c.triggerBar.rightPosition+i)}}if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}c.drawControllerPart()}};var b=function(f){if(c.triggerBar){}c.triggerBar=null;document.body.style.cursor="default";if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}};var e=function(f){var g=c.isOnLeftBar(f);var i=c.isOnRightBar(f);var h=c._isBetweenLeftAndRight(f);if(h){document.body.style.cursor="pointer"}else{if(g||i){document.body.style.cursor="col-resize"}else{document.body.style.cursor="default"}}if(g){c.triggerBar={type:"left",x:f.offsetX,position:c.leftBarPosition}}else{if(i){c.triggerBar={type:"right",x:f.offsetX,position:c.rightBarPosition}}else{if(h){c.triggerBar={type:"middle",x:f.offsetX,leftPosition:c.leftBarPosition,rightPosition:c.rightBarPosition}}else{c.triggerBar=null}}}};addEvent(c.canvas,"mouseup",b);addEvent(c.canvas,"mouseout",b);addEvent(c.canvas,"mousemove",function(f){f=f||event;if(f.preventDefault){f.preventDefault()}else{f.returnValue=false}var g=getOffset(f);d(g)});addEvent(c.canvas,"mousedown",function(f){f=f||event;var g=getOffset(f);e(g)})}},isValueChanged:function(){if(typeof this.preValue=="undefined"){this.preValue=this.getValue();return false}if(isTouchDevice()&&this.latestChangeTime){var b=new Date();if(b.getTime()-this.latestChangeTime.getTime()<50){return false}}var c=this.preValue;var e=this.getValue();var a=Math.abs(e.left-c.left)+Math.abs(e.right-c.right);this.preValue=e;var d=a!=0;if(d){this.latestChangeTime=new Date()}return a!=0},_isInRegion:function(a,b){return a.offsetX>b.x&&a.offsetX<b.x+b.width&&a.offsetY>b.y&&a.offsetY<b.y+b.height},_isBetweenLeftAndRight:function(a){var c=this.region;var b={x:c.x+this.leftBarPosition+this.bar.width/2,y:c.y,width:this.rightBarPosition-this.leftBarPosition-this.bar.width,height:this.region.height};return this._isInRegion(a,b)},_getTouchFaultToleranceRegion:function(b){var a=this;if(a.isTouchDevice){b.x-=a.touchFaultTolerance/2;b.width+=a.touchFaultTolerance/2}return b},isOnLeftBar:function(a){var b=this._getTouchFaultToleranceRegion(this.leftBarRegion);return this._isInRegion(a,b)},isOnRightBar:function(a){var b=this._getTouchFaultToleranceRegion(this.rightBarRegion);return this._isInRegion(a,b)},getValue:function(){var a=this.region.width-this.bar.width;return{left:(this.leftBarPosition-this.bar.width/2)*100/a,right:(this.rightBarPosition-this.bar.width/2)*100/a}}};
</script>
  </head>
  <body>
  <canvas id="canvas" width="600" height="500" style=""></canvas>  
  <div id="debug"></div>

  <script>
var c=new controller("canvas",{region:{x:0.5,height:60,y:400.5,width:599,borderColor:"black"},bar:{width:20,height:35,borderColor:"black",fillColor:"lightgray"},value:{left:90,right:100},minBarDistance:20,onPositionChanged:function(a){setDebugMsg("left = "+a.left+",right = "+a.right)},touchFaultTolerance:20});c.drawControllerPart();c.addControllerEvents();
</script>
  </body>
</html>